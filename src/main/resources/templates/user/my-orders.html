<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>My Orders - Cosmic Travel</title>
    
    <script src="https://app.sandbox.midtrans.com/snap/snap.js" 
            data-client-key="Mid-client-4OmyuQsfZLnSMKw_"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- CUSTOM CHECKBOX --- */
        .cosmic-checkbox {
            appearance: none; width: 1.5rem; height: 1.5rem;
            border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.05); cursor: pointer;
            transition: all 0.3s ease; display: flex; align-items: center; justify-content: center;
        }
        .cosmic-checkbox:checked {
            background-color: #FF8A5B; border-color: #FF8A5B;
            box-shadow: 0 0 15px rgba(255, 138, 91, 0.5);
        }
        .cosmic-checkbox:checked::after {
            content: '✔'; color: #0B0F19; font-size: 0.8rem; font-weight: 900;
        }

        /* --- FLOATING CHECKOUT BAR --- */
        #checkout-bar { transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 50; }
        #checkout-bar.hidden-bar { transform: translateY(150%) scale(0.95); opacity: 0; pointer-events: none; }
        
        /* --- CARD HOVER --- */
        .order-card { transition: all 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.05); }
        .order-card:hover {
            background: rgba(255, 255, 255, 0.03); border-color: rgba(255, 138, 91, 0.4);
            transform: translateY(-2px); box-shadow: 0 20px 40px -15px rgba(0, 0, 0, 0.5);
        }

        /* --- CUSTOM SCROLLBAR --- */
        #selected-items-container::-webkit-scrollbar { width: 4px; }
        #selected-items-container::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }
        #selected-items-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

        /* --- SEARCH BOX ANIMATION (SQUARE FIXED) --- */
        .search-container {
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s, box-shadow 0.3s;
            overflow: hidden;
            width: 4rem; height: 4rem; /* KOTAK */
            background: linear-gradient(135deg, #FF8A5B 0%, #ea580c 100%);
            position: relative; cursor: pointer; border-radius: 0.75rem;
            box-shadow: 0 10px 25px -5px rgba(255, 138, 91, 0.4);
        }
        .search-container.expanded {
            width: 22rem; box-shadow: 0 0 30px rgba(255, 138, 91, 0.3);
        }
        
        .search-input {
            opacity: 0; width: 100%; height: 100%; position: absolute; left: 0; top: 0;
            background: transparent; border: none; color: white; font-weight: 500;
            padding-left: 3.5rem; padding-right: 3.5rem; z-index: 10;
            transition: opacity 0.3s ease 0.1s; pointer-events: none;
        }
        .search-container.expanded .search-input { opacity: 1; pointer-events: auto; }
        .search-input::placeholder { color: rgba(255, 255, 255, 0.8); }

        /* Magnifier: Tengah saat tutup, Kiri saat buka */
        .search-magnifier {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            color: #FFFFFF; opacity: 1; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none; font-size: 1.5rem; z-index: 25;
        }
        .search-container.expanded .search-magnifier { left: 1.5rem; transform: translate(0, -50%); }

        /* Glasses Icon: Kanan */
        .search-icon-btn {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); position: absolute; right: 0; top: 0;
            height: 100%; width: 4rem; display: flex; align-items: center; justify-content: center;
            z-index: 20; opacity: 0; transform: scale(0.5) rotate(-90deg);
        }
        .search-container.expanded .search-icon-btn { opacity: 1; transform: scale(1) rotate(0deg); }

        /* --- SWEETALERT THEME --- */
        div:where(.swal2-container) div:where(.swal2-popup) {
            background: #151C2C !important; border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem; color: #E2E8F0;
        }
        div:where(.swal2-container) h2:where(.swal2-title) { color: #fff; }
        div:where(.swal2-icon).swal2-warning { border-color: #FBBF24; color: #FBBF24; }
        div:where(.swal2-icon).swal2-error { border-color: #EF4444; color: #EF4444; }
        div:where(.swal2-icon).swal2-success { border-color: #10B981; color: #10B981; }
        div:where(.swal2-container) button:where(.swal2-styled).swal2-confirm {
            background: linear-gradient(135deg, #FF8A5B 0%, #ea580c 100%) !important;
            border-radius: 0.75rem; font-weight: bold; box-shadow: 0 4px 15px rgba(255, 138, 91, 0.4);
        }
        div:where(.swal2-container) button:where(.swal2-styled).swal2-cancel {
            background: rgba(255, 255, 255, 0.1) !important; border-radius: 0.75rem; color: #ccc;
        }
    </style>
</head>
<body>
    <th:block th:replace="~{fragment/user-layout :: layout(title='My Orders', content=~{::content})}">
        <div th:fragment="content">
            
            <input type="hidden" id="snapToken" th:value="${snapToken}" />

            <div class="container mx-auto px-6 py-12 min-h-screen flex flex-col relative">
                
                <div class="flex flex-col md:flex-row justify-between items-end mb-12 gap-6">
                    <div class="flex items-center gap-5">
                        
                        <div class="search-container shadow-2xl shadow-brand-accent/20" onclick="toggleSearch(this)">
                            <div class="search-magnifier"><i class="ri-search-2-line"></i></div>
                            <input type="text" id="orderSearchInput" class="search-input" placeholder="Cari pesanan..." onclick="event.stopPropagation()" autocomplete="off">
                            <div class="search-icon-btn text-white text-2xl"><i class="ri-sunglasses-fill"></i></div>
                        </div>

                        <div>
                            <h1 class="text-4xl font-bold text-white tracking-tight">My <span class="text-transparent bg-clip-text bg-gradient-to-r from-brand-accent to-yellow-200 font-serif italic">Journeys</span></h1>
                            <p class="text-gray-400 mt-1">Kelola dan bayar tiket perjalanan Anda.</p>
                        </div>
                    </div>

                    <div class="glass-panel p-1.5 rounded-2xl flex gap-2 bg-white/5 border border-white/10">
                        <button onclick="switchTab('pending')" id="tab-pending" class="px-6 py-2.5 rounded-xl text-sm font-bold transition-all bg-brand-accent text-brand-dark shadow-lg shadow-brand-accent/20 flex items-center gap-2">
                            Waiting Payment <span class="bg-brand-dark/20 px-2 py-0.5 rounded-md text-xs" th:text="${#lists.size(pendingOrders)}">0</span>
                        </button>
                        <button onclick="switchTab('history')" id="tab-history" class="px-6 py-2.5 rounded-xl text-sm font-bold text-gray-400 hover:text-white hover:bg-white/5 transition-all">
                            History
                        </button>
                    </div>
                </div>

                <div th:if="${successMessage}" class="mb-8 p-4 rounded-2xl bg-green-500/10 border border-green-500/20 text-green-400 flex items-center gap-3 backdrop-blur-md animate-fade-in-down">
                    <i class="ri-check-double-line text-xl"></i> <span th:text="${successMessage}"></span>
                </div>
                <div th:if="${errorMessage}" class="mb-8 p-4 rounded-2xl bg-red-500/10 border border-red-500/20 text-red-400 flex items-center gap-3 backdrop-blur-md animate-fade-in-down">
                    <i class="ri-error-warning-line text-xl"></i> <span th:text="${errorMessage}"></span>
                </div>

                <form id="checkoutForm" th:action="@{/order/checkout}" method="POST">
                    
                    <div id="pending-section" class="space-y-4 pb-48">
                        <div th:if="${#lists.isEmpty(pendingOrders)}" class="glass-panel p-16 rounded-3xl text-center flex flex-col items-center justify-center border border-dashed border-white/10">
                            <div class="w-20 h-20 bg-white/5 rounded-full flex items-center justify-center mb-6 text-gray-600"><i class="ri-shopping-bag-3-line text-3xl"></i></div>
                            <h2 class="text-xl font-bold text-white">Keranjang Kosong</h2>
                            <p class="text-gray-500 mb-8 mt-2 text-sm">Belum ada item yang menunggu pembayaran.</p>
                            <a th:href="@{/}" class="px-8 py-3 rounded-full border border-white/20 text-white hover:bg-brand-accent hover:text-brand-dark hover:border-brand-accent transition-all font-medium">Mulai Petualangan</a>
                        </div>

                        <div th:each="order : ${pendingOrders}" class="order-card glass-panel rounded-3xl flex items-center overflow-hidden bg-brand-dark/30 backdrop-blur-md relative searchable-item">
                            <div class="w-16 self-stretch flex items-center justify-center border-r border-white/5 bg-white/[0.02] cursor-pointer hover:bg-white/[0.05] transition-colors" onclick="if(event.target.tagName !== 'INPUT') this.querySelector('input').click()">
                                <input type="checkbox" name="orderIds" th:value="${order.orderId}" th:data-price="${#aggregates.sum(order.orderDetails.![totalPrice])}" onchange="calculateTotal(); event.stopPropagation();" class="cosmic-checkbox">
                            </div>
                            <div class="flex-1 p-6">
                                <div th:each="detail : ${order.orderDetails}">
                                    <div class="flex items-center gap-3 mb-3">
                                        <span class="text-[10px] font-bold uppercase tracking-widest px-2 py-1 rounded border" th:classappend="${detail.hotelRoom != null ? 'border-orange-500/30 text-orange-400 bg-orange-500/5' : (detail.attractionTicket != null ? 'border-green-500/30 text-green-400 bg-green-500/5' : 'border-purple-500/30 text-purple-400 bg-purple-500/5')}" th:text="${detail.hotelRoom != null ? 'HOTEL' : (detail.attractionTicket != null ? 'ATTRACTION' : 'TRANSPORT')}">TYPE</span>
                                        <span class="text-xs text-gray-600 font-mono search-id" th:text="'#' + ${order.orderId}">#ID</span>
                                    </div>
                                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                        <div class="flex items-center gap-4">
                                            <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl shadow-inner flex-shrink-0" th:classappend="${detail.hotelRoom != null ? 'bg-orange-500/10 text-orange-400' : (detail.attractionTicket != null ? 'bg-green-500/10 text-green-400' : 'bg-purple-500/10 text-purple-400')}">
                                                <i th:if="${detail.hotelRoom != null}" class="ri-hotel-bed-fill"></i><i th:if="${detail.attractionTicket != null}" class="ri-camera-3-fill"></i><i th:if="${detail.transportTicket != null}" class="ri-plane-fill"></i>
                                            </div>
                                            <div>
                                                <a th:if="${detail.hotelRoom != null}" th:href="@{/hotel/detail/{id}(id=${detail.hotelRoom.hotel.hotelId})}" th:text="${detail.hotelRoom.hotel.name}" class="item-name block text-xl font-bold text-white leading-snug hover:text-brand-accent hover:underline decoration-2 underline-offset-4 transition-all cursor-pointer search-name"></a>
                                                <a th:if="${detail.attractionTicket != null}" th:href="@{/attraction/detail/{id}(id=${detail.attractionTicket.attraction.attractionId})}" th:text="${detail.attractionTicket.attraction.name}" class="item-name block text-xl font-bold text-white leading-snug hover:text-brand-accent hover:underline decoration-2 underline-offset-4 transition-all cursor-pointer search-name"></a>
                                                <a th:if="${detail.transportTicket != null}" th:href="@{/transport/detail/{id}(id=${detail.transportTicket.transport.transportId})}" th:text="${detail.transportTicket.transport.name}" class="item-name block text-xl font-bold text-white leading-snug hover:text-brand-accent hover:underline decoration-2 underline-offset-4 transition-all cursor-pointer search-name"></a>
                                                <p class="text-sm text-gray-400 mt-0.5"><span th:if="${detail.hotelRoom != null}" th:text="${detail.hotelRoom.roomType}"></span><span th:if="${detail.attractionTicket != null}" th:text="${detail.attractionTicket.ticketType}"></span><span th:if="${detail.transportTicket != null}" th:text="${detail.transportTicket.ticketClass}"></span><span class="mx-1 text-gray-600">•</span><span class="text-gray-300" th:text="${detail.quantity} + ' Pax'"></span></p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-6 w-full md:w-auto justify-between md:justify-end">
                                            <div class="text-right"><p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Total</p><p class="text-2xl font-bold text-brand-accent font-sans" th:text="'Rp ' + ${#numbers.formatDecimal(detail.totalPrice, 0, 'POINT', 0, 'COMMA')}">Rp 0</p></div>
                                            <button type="button" th:onclick="'cancelOrder(' + ${order.orderId} + ')'" class="w-10 h-10 rounded-full border border-white/10 text-gray-400 hover:bg-red-500/10 hover:text-red-500 hover:border-red-500/50 transition-all flex items-center justify-center" title="Hapus Item"><i class="ri-delete-bin-line"></i></button>
                                        </div>
                                    </div>
                                    <div class="mt-4 pt-4 border-t border-white/5 flex items-center gap-4 text-sm text-gray-500 font-mono">
                                        <div class="flex items-center gap-2"><i class="ri-calendar-event-line"></i><span th:text="${#dates.format(detail.checkInDate, 'dd MMM yyyy')}">In</span></div>
                                        <div th:if="${detail.checkOutDate != null}" class="flex items-center gap-2"><i class="ri-arrow-right-line text-gray-700"></i><span th:text="${#dates.format(detail.checkOutDate, 'dd MMM yyyy')}">Out</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="history-section" class="hidden space-y-4 pb-20">
                         <div th:if="${#lists.isEmpty(historyOrders)}" class="text-center py-20 text-gray-500"><i class="ri-history-line text-4xl mb-4 block opacity-50"></i>Belum ada riwayat transaksi selesai.</div>
                        <div th:each="order : ${historyOrders}" class="glass-panel p-5 rounded-2xl flex flex-col md:flex-row items-center gap-6 border border-white/5 opacity-60 hover:opacity-100 transition-all">
                            <div class="flex items-center gap-4 flex-1">
                                <div class="w-12 h-12 rounded-xl bg-brand-dark flex items-center justify-center text-gray-400 border border-white/5"><i class="ri-check-double-line text-xl"></i></div>
                                <div><h4 class="text-white font-bold text-lg" th:text="'Order #' + ${order.orderId}">Order #1</h4><p class="text-sm text-gray-500" th:text="${#dates.format(order.orderDate, 'dd MMM yyyy, HH:mm')}">Date</p></div>
                            </div>
                            
                            <div class="flex items-center gap-4 justify-end">
                                <span class="px-3 py-1 rounded-full text-xs font-bold uppercase border border-green-500/30 text-green-400 bg-green-500/10 whitespace-nowrap">Paid</span>
                                <p class="text-white font-bold text-lg text-right w-36" th:text="'Rp ' + ${#numbers.formatDecimal(#aggregates.sum(order.orderDetails.![totalPrice]), 0, 'POINT', 0, 'COMMA')}">Rp 0</p>
                            </div>
                        </div>
                    </div>

                    <div id="checkout-bar" class="fixed bottom-6 left-6 right-6 md:left-auto md:right-10 md:w-[32rem] z-50 hidden-bar">
                        <div class="glass-panel bg-[#0B0F19]/95 backdrop-blur-2xl p-6 rounded-[2rem] border border-brand-accent/30 shadow-[0_10px_40px_-10px_rgba(255,138,91,0.2)] flex flex-col gap-5">
                            <div class="border-b border-white/10 pb-4">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-2"><span class="w-5 h-5 rounded-full bg-brand-accent text-brand-dark flex items-center justify-center text-[10px] font-bold" id="selected-count">0</span><span class="text-gray-400 text-xs font-medium uppercase tracking-wide">Item terpilih</span></div>
                                </div>
                                <div id="selected-items-container" class="space-y-2 max-h-24 overflow-y-auto pr-2 custom-scrollbar"><p class="text-gray-500 text-sm italic">Belum ada item dipilih...</p></div>
                            </div>
                            <div class="flex justify-between items-center">
                                <div><p class="text-xs text-gray-500 uppercase tracking-wider mb-0.5">Total Pembayaran</p><p id="total-price" class="text-3xl font-bold text-brand-accent tracking-tight">Rp 0</p></div>
                                <button type="submit" class="bg-gradient-to-r from-brand-accent to-orange-600 text-white font-bold px-8 py-3 rounded-xl shadow-lg shadow-brand-accent/20 hover:scale-105 hover:shadow-brand-accent/40 transition-all flex items-center gap-2 group"><span>Bayar Sekarang</span><i class="ri-arrow-right-line group-hover:translate-x-1 transition-transform"></i></button>
                            </div>
                        </div>
                    </div>
                </form>
                <form id="cancelForm" method="POST" style="display: none;"></form>
            </div>

            <script>
                document.addEventListener("DOMContentLoaded", function() {
                    const snapToken = document.getElementById('snapToken').value;
                    if (snapToken) {
                        window.snap.pay(snapToken, {
                            onSuccess: function(result) {
                                Swal.fire({ icon: 'success', title: 'Pembayaran Berhasil!', text: 'Tiket Anda telah diterbitkan.', background: '#151C2C', color: '#fff', confirmButtonColor: '#10B981', iconColor: '#10B981' }).then(() => { window.location.href = "/my-orders"; });
                            },
                            onPending: function(result) {
                                Swal.fire({ icon: 'info', title: 'Menunggu Pembayaran', text: 'Silakan selesaikan pembayaran Anda.', background: '#151C2C', color: '#fff', confirmButtonColor: '#FBBF24', iconColor: '#FBBF24' }).then(() => { window.location.href = "/my-orders"; });
                            },
                            onError: function(result) {
                                Swal.fire({ icon: 'error', title: 'Pembayaran Gagal', text: 'Terjadi kesalahan saat memproses pembayaran.', background: '#151C2C', color: '#fff', confirmButtonColor: '#EF4444', iconColor: '#EF4444' }).then(() => { window.location.href = "/my-orders"; });
                            },
                            onClose: function() {
                                Swal.fire({ icon: 'warning', title: 'Dibatalkan', text: 'Anda menutup popup pembayaran.', background: '#151C2C', color: '#fff', confirmButtonColor: '#6B7280', iconColor: '#6B7280' });
                            }
                        });
                    }
                    calculateTotal();
                });

                function switchTab(tabName) {
                    const pendingSec = document.getElementById('pending-section');
                    const historySec = document.getElementById('history-section');
                    const tabPending = document.getElementById('tab-pending');
                    const tabHistory = document.getElementById('tab-history');
                    const checkoutBar = document.getElementById('checkout-bar');

                    if (tabName === 'pending') {
                        pendingSec.classList.remove('hidden'); historySec.classList.add('hidden');
                        tabPending.classList.add('bg-brand-accent', 'text-brand-dark', 'shadow-lg'); tabPending.classList.remove('text-gray-400', 'hover:bg-white/5');
                        tabHistory.classList.remove('bg-brand-accent', 'text-brand-dark', 'shadow-lg'); tabHistory.classList.add('text-gray-400', 'hover:bg-white/5');
                        calculateTotal();
                    } else {
                        pendingSec.classList.add('hidden'); historySec.classList.remove('hidden');
                        tabHistory.classList.add('bg-brand-accent', 'text-brand-dark', 'shadow-lg'); tabHistory.classList.remove('text-gray-400', 'hover:bg-white/5');
                        tabPending.classList.remove('bg-brand-accent', 'text-brand-dark', 'shadow-lg'); tabPending.classList.add('text-gray-400', 'hover:bg-white/5');
                        checkoutBar.classList.add('hidden-bar');
                    }
                }

                function calculateTotal() {
                    const checkboxes = document.querySelectorAll('.cosmic-checkbox:checked');
                    let total = 0;
                    const itemsContainer = document.getElementById('selected-items-container');
                    itemsContainer.innerHTML = '';
                    const formatter = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 });
                    if (checkboxes.length === 0) itemsContainer.innerHTML = '<p class="text-gray-500 text-sm italic">Belum ada item dipilih...</p>';
                    checkboxes.forEach(cb => {
                        const price = parseFloat(cb.getAttribute('data-price'));
                        total += price;
                        const card = cb.closest('.order-card');
                        const nameEl = card.querySelector('.item-name');
                        if (nameEl) {
                            const nameText = nameEl.innerText.trim();
                            const priceText = formatter.format(price);
                            const row = document.createElement('div');
                            row.className = "flex justify-between items-center text-sm group/item";
                            row.innerHTML = `<span class="text-white font-medium truncate mr-4 group-hover/item:text-brand-accent transition-colors">${nameText}</span><span class="text-gray-400 font-mono whitespace-nowrap">${priceText}</span>`;
                            itemsContainer.appendChild(row);
                        }
                    });
                    document.getElementById('selected-count').innerText = checkboxes.length;
                    document.getElementById('total-price').innerText = formatter.format(total);
                    const bar = document.getElementById('checkout-bar');
                    const pendingVisible = !document.getElementById('pending-section').classList.contains('hidden');
                    if (checkboxes.length > 0 && pendingVisible) bar.classList.remove('hidden-bar'); else bar.classList.add('hidden-bar');
                }

                function cancelOrder(orderId) {
                    Swal.fire({ title: 'Hapus Item?', text: "Item ini akan dihapus dari keranjang.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'Ya, Hapus!', background: '#151C2C', color: '#fff' }).then((result) => {
                        if (result.isConfirmed) {
                            const form = document.getElementById('cancelForm');
                            form.action = '/order/cancel/' + orderId;
                            form.submit();
                        }
                    });
                }

                function toggleSearch(container) {
                    const input = container.querySelector('input');
                    if (container.classList.contains('expanded')) {
                         if (document.activeElement === input) return;
                         container.classList.remove('expanded');
                    } else {
                        container.classList.add('expanded');
                        setTimeout(() => input.focus(), 300); 
                    }
                }
                document.addEventListener('click', function(event) {
                    const searchContainer = document.querySelector('.search-container');
                    if (searchContainer && !searchContainer.contains(event.target)) {
                        searchContainer.classList.remove('expanded');
                    }
                });
                document.getElementById('orderSearchInput').addEventListener('keyup', function() {
                    const filter = this.value.toLowerCase();
                    const items = document.querySelectorAll('.searchable-item');
                    items.forEach(item => {
                        const nameEl = item.querySelector('.search-name');
                        const idEl = item.querySelector('.search-id');
                        const textName = nameEl ? nameEl.textContent.toLowerCase() : '';
                        const textId = idEl ? idEl.textContent.toLowerCase() : '';
                        if (textName.includes(filter) || textId.includes(filter)) item.style.display = ""; else item.style.display = "none";
                    });
                });
            </script>
        </div>
    </th:block>
</body>
</html>
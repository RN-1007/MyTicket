<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>My Orders</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="Mid-client-4OmyuQsfZLnSMKw_"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }

        /* 1. Search Bar Animation (Mobile Version) */
        .search-container { 
            transition: width 0.4s cubic-bezier(0.25, 1, 0.5, 1), box-shadow 0.3s; 
            overflow: hidden; 
            width: 3rem; /* Awal kecil (ikon saja) */
            height: 3rem; 
            background: linear-gradient(135deg, #FF8A5B 0%, #ea580c 100%); 
            position: relative; 
            cursor: pointer; 
            border-radius: 9999px; /* Pill shape */
            box-shadow: 0 4px 15px rgba(255, 138, 91, 0.4); 
        }
        .search-container.expanded { 
            width: 100%; /* Melebar penuh saat aktif */
            border-radius: 1rem;
            box-shadow: 0 0 25px rgba(255, 138, 91, 0.2); 
        }
        .search-input { 
            opacity: 0; 
            width: 100%; 
            height: 100%; 
            position: absolute; 
            left: 0; top: 0; 
            background: transparent; 
            border: none; 
            color: white; 
            font-weight: 500; 
            padding-left: 3rem; 
            padding-right: 3rem; 
            transition: opacity 0.3s ease 0.1s; 
            pointer-events: none; 
        }
        .search-container.expanded .search-input { opacity: 1; pointer-events: auto; }
        .search-input:focus { outline: none; }
        .search-input::placeholder { color: rgba(255, 255, 255, 0.7); }
        
        .search-icon { 
            position: absolute; 
            right: 0; top: 0; 
            width: 3rem; height: 3rem; 
            display: flex; align-items: center; justify-content: center; 
            color: white; font-size: 1.25rem; 
            pointer-events: none;
        }
        .search-magnifier {
            position: absolute; left: 0; top: 0;
            width: 3rem; height: 3rem;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 1.25rem;
            pointer-events: none;
        }

        /* 2. Custom Checkbox */
        .cosmic-checkbox { 
            appearance: none; width: 1.5rem; height: 1.5rem; 
            border: 2px solid rgba(255,255,255,0.2); 
            border-radius: 0.5rem; 
            background-color: rgba(255,255,255,0.05); 
            cursor: pointer; transition: all 0.2s; 
            display: grid; place-content: center;
        }
        .cosmic-checkbox:checked { 
            background-color: #FF8A5B; border-color: #FF8A5B; 
        }
        .cosmic-checkbox:checked::after { 
            content: 'âœ“'; color: #0B0F19; font-weight: 900; font-size: 0.9rem; 
        }

        /* 3. Checkout Bar */
        #checkout-bar { transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 40; }
        #checkout-bar.hidden-bar { transform: translateY(150%); }
    </style>
</head>
<body>
    <div th:replace="~{fragment/mobile-layout :: layout(title='Pesanan Saya', content=~{::content})}">
        <div th:fragment="content">
            
            <input type="hidden" id="snapToken" th:value="${snapToken}" />

            <div class="px-5 pt-8 pb-32 min-h-screen">
                
                <div class="flex items-end justify-between mb-6 gap-4">
                    <div class="flex-1">
                        <h1 class="text-3xl font-bold text-white tracking-tight leading-none">My <span class="text-transparent bg-clip-text bg-gradient-to-r from-brand-accent to-yellow-200 font-serif italic">Journeys</span></h1>
                        <p class="text-gray-400 text-xs mt-1">Kelola tiket perjalanan Anda.</p>
                    </div>
                    
                    <div class="search-container flex-shrink-0" onclick="toggleSearch(this)">
                        <div class="search-magnifier"><i class="ri-search-2-line"></i></div>
                        <input type="text" id="orderSearchInput" class="search-input" placeholder="Cari..." onclick="event.stopPropagation()" autocomplete="off">
                        <div class="search-icon"><i class="ri-close-line" style="opacity: 0;"></i></div> </div>
                </div>

                <div class="bg-white/5 border border-white/10 p-1.5 rounded-2xl flex gap-2 mb-6 backdrop-blur-md">
                    <button type="button" onclick="switchTab('pending')" id="tab-pending" 
                            class="flex-1 py-3 rounded-xl text-xs font-bold transition-all duration-300 bg-brand-accent text-[#0B0F19] shadow-lg shadow-brand-accent/20 flex items-center justify-center gap-2">
                        Menunggu <span class="bg-[#0B0F19]/20 px-2 py-0.5 rounded text-[10px]" th:text="${#lists.size(pendingOrders)}">0</span>
                    </button>
                    <button type="button" onclick="switchTab('history')" id="tab-history" 
                            class="flex-1 py-3 rounded-xl text-xs font-bold text-gray-400 hover:text-white hover:bg-white/5 transition-all text-center">
                        Riwayat
                    </button>
                </div>

                <div th:if="${successMessage}" class="mb-6 p-4 rounded-xl bg-green-500/10 border border-green-500/20 text-green-400 flex items-center gap-3 backdrop-blur-md text-xs">
                    <i class="ri-check-double-line text-lg"></i> <span th:text="${successMessage}"></span>
                </div>
                <div th:if="${errorMessage}" class="mb-6 p-4 rounded-xl bg-red-500/10 border border-red-500/20 text-red-400 flex items-center gap-3 backdrop-blur-md text-xs">
                    <i class="ri-error-warning-line text-lg"></i> <span th:text="${errorMessage}"></span>
                </div>

                <form id="checkoutForm" th:action="@{/android/order/checkout}" method="POST">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    
                    <div id="pending-section" class="space-y-4">
                        
                        <div th:if="${#lists.isEmpty(pendingOrders)}" class="bg-white/5 border border-dashed border-white/10 p-10 rounded-3xl text-center">
                            <div class="w-14 h-14 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-500"><i class="ri-shopping-cart-2-line text-2xl"></i></div>
                            <p class="text-gray-500 text-xs">Keranjang kosong.</p>
                            <a th:href="@{/android}" class="mt-4 inline-block text-brand-accent text-xs font-bold border border-brand-accent/30 px-5 py-2 rounded-full hover:bg-brand-accent hover:text-[#0B0F19] transition-colors">Mulai Belanja</a>
                        </div>

                        <div th:each="order : ${pendingOrders}" class="bg-[#151C2C] p-4 rounded-2xl border border-white/5 relative overflow-hidden group searchable-item shadow-lg">
                            <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-brand-accent rounded-r-full"></div>

                            <div class="absolute top-4 right-4 z-10">
                                <input type="checkbox" name="orderIds" th:value="${order.orderId}" 
                                       th:data-price="${#aggregates.sum(order.orderDetails.![totalPrice])}" 
                                       onchange="calcTotal()" 
                                       class="cosmic-checkbox">
                            </div>

                            <div th:each="detail : ${order.orderDetails}" class="flex gap-4 pl-3">
                                <div class="w-20 h-20 rounded-xl bg-[#252E3E] flex items-center justify-center flex-shrink-0 border border-white/5 overflow-hidden relative">
                                     <img th:if="${detail.hotelRoom != null && detail.hotelRoom.hotel.image != null}" th:src="@{${detail.hotelRoom.hotel.imagePath}}" class="w-full h-full object-cover">
                                     <img th:if="${detail.attractionTicket != null && detail.attractionTicket.attraction.image != null}" th:src="@{${detail.attractionTicket.attraction.imagePath}}" class="w-full h-full object-cover">
                                     <img th:if="${detail.transportTicket != null && detail.transportTicket.transport.image != null}" th:src="@{${detail.transportTicket.transport.imagePath}}" class="w-full h-full object-cover">
                                     
                                     <div th:if="${(detail.hotelRoom != null && detail.hotelRoom.hotel.image == null) || (detail.attractionTicket != null && detail.attractionTicket.attraction.image == null) || (detail.transportTicket != null && detail.transportTicket.transport.image == null)}" 
                                          class="text-3xl text-gray-600">
                                         <i th:if="${detail.hotelRoom != null}" class="ri-hotel-bed-fill"></i>
                                         <i th:if="${detail.attractionTicket != null}" class="ri-camera-3-fill"></i>
                                         <i th:if="${detail.transportTicket != null}" class="ri-plane-fill"></i>
                                     </div>
                                </div>

                                <div class="flex-1 min-w-0 flex flex-col justify-between py-0.5">
                                    <div>
                                        <h3 class="text-white font-bold text-sm leading-tight truncate pr-8 search-name" 
                                            th:text="${detail.hotelRoom != null ? detail.hotelRoom.hotel.name : (detail.attractionTicket != null ? detail.attractionTicket.attraction.name : detail.transportTicket.transport.name)}">
                                            Item Name
                                        </h3>
                                        <p class="text-gray-400 text-[10px] mt-1 truncate">
                                            <span th:if="${detail.hotelRoom != null}" th:text="${detail.hotelRoom.roomType}"></span>
                                            <span th:if="${detail.attractionTicket != null}" th:text="${detail.attractionTicket.ticketType}"></span>
                                            <span th:if="${detail.transportTicket != null}" th:text="${detail.transportTicket.ticketClass}"></span>
                                        </p>
                                        <p class="text-gray-500 text-[10px] mt-0.5 flex items-center gap-1 font-medium">
                                            <i class="ri-calendar-line"></i>
                                            <span th:text="${#dates.format(detail.checkInDate, 'dd MMM yyyy')}">Date</span>
                                        </p>
                                    </div>

                                    <div class="flex justify-between items-end mt-2">
                                        <p class="text-brand-accent font-bold text-base" th:text="'Rp ' + ${#numbers.formatDecimal(detail.totalPrice, 0, 'POINT', 0, 'COMMA')}">Rp 0</p>
                                        <button type="button" th:onclick="'cancelOrder(' + ${order.orderId} + ')'" 
                                                class="px-3 py-1.5 rounded-lg bg-red-500/10 border border-red-500/20 text-red-400 text-[10px] font-bold hover:bg-red-500/20 active:scale-95 transition-all flex items-center gap-1">
                                            <i class="ri-delete-bin-line"></i> Hapus
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="history-section" class="hidden space-y-4">
                        <div th:each="order : ${historyOrders}" class="bg-[#151C2C] p-5 rounded-2xl border border-white/5 relative overflow-hidden shadow-lg searchable-item">
                            <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-green-500 rounded-r-full opacity-80"></div>

                            <div class="flex justify-between items-start mb-3 pl-3">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-gray-400 border border-white/10">
                                        <i class="ri-shopping-bag-3-fill"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-white font-bold text-sm">Invoice #<span class="search-id" th:text="${order.orderId}"></span></h4>
                                        <p class="text-gray-500 text-[10px]" th:text="${#dates.format(order.orderDate, 'dd MMM yyyy, HH:mm')}">Date</p>
                                    </div>
                                </div>
                                <span class="bg-green-500/10 text-green-400 border border-green-500/20 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider">PAID</span>
                            </div>

                            <div class="border-t border-white/5 mb-3 ml-3"></div>

                            <div class="flex justify-between items-center pl-3">
                                <div>
                                    <p class="text-[10px] text-gray-500 uppercase tracking-wider font-bold">Total</p>
                                    <p class="text-white font-bold text-sm" th:text="'Rp ' + ${#numbers.formatDecimal(#aggregates.sum(order.orderDetails.![totalPrice]), 0, 'POINT', 0, 'COMMA')}">Rp 0</p>
                                </div>
                                <a th:href="@{/android/order/invoice/{id}(id=${order.orderId})}" 
                                   class="px-4 py-2 rounded-xl bg-brand-accent/10 border border-brand-accent/20 text-brand-accent text-xs font-bold hover:bg-brand-accent hover:text-[#0B0F19] transition-all flex items-center gap-2 active:scale-95">
                                    <i class="ri-file-text-line"></i> Invoice
                                </a>
                            </div>
                        </div>

                        <div th:if="${#lists.isEmpty(historyOrders)}" class="text-center py-12">
                            <i class="ri-history-line text-3xl text-gray-600 mb-2 block"></i>
                            <p class="text-gray-500 text-xs">Belum ada riwayat transaksi.</p>
                        </div>
                    </div>

                    <div id="checkout-bar" class="fixed bottom-24 left-4 right-4 z-40 hidden-bar">
                        <div class="bg-[#151C2C]/95 backdrop-blur-xl p-4 rounded-3xl border border-brand-accent/30 shadow-[0_10px_40px_-10px_rgba(255,138,91,0.3)] flex flex-col gap-3">
                            <div class="flex justify-between items-center px-1">
                                <div>
                                    <p class="text-[10px] text-gray-400 uppercase tracking-widest font-bold">Total Payment</p>
                                    <p id="total-text" class="text-lg font-bold text-white">Rp 0</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-400 text-[10px]"><span id="selected-count">0</span> Item</span>
                                </div>
                            </div>
                            <button type="button" onclick="document.getElementById('checkoutForm').submit()" class="w-full bg-gradient-to-r from-brand-accent to-orange-600 text-white font-bold py-3.5 rounded-2xl shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2 text-sm">
                                <span>Bayar Sekarang</span> <i class="ri-arrow-right-line"></i>
                            </button>
                        </div>
                    </div>
                </form>
                
                <form id="cancelForm" method="POST" style="display:none;"><input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" /></form>
            </div>

            <script>
                document.addEventListener("DOMContentLoaded", function() {
                    // Midtrans Logic
                    const snapToken = document.getElementById('snapToken').value;
                    if (snapToken) {
                        window.snap.pay(snapToken, {
                            onSuccess: () => { window.location.href = '/android/my-orders'; },
                            onPending: () => { window.location.href = '/android/my-orders'; },
                            onError: () => { window.location.href = '/android/my-orders'; }
                        });
                    }
                });

                // Tab Switcher Logic
                function switchTab(tabName) {
                    const pendingSec = document.getElementById('pending-section');
                    const historySec = document.getElementById('history-section');
                    const tabPending = document.getElementById('tab-pending');
                    const tabHistory = document.getElementById('tab-history');
                    const checkoutBar = document.getElementById('checkout-bar');

                    if (tabName === 'pending') {
                        pendingSec.classList.remove('hidden'); 
                        historySec.classList.add('hidden');
                        
                        // Active Style Pending
                        tabPending.className = "flex-1 py-3 rounded-xl text-xs font-bold transition-all duration-300 bg-brand-accent text-[#0B0F19] shadow-lg shadow-brand-accent/20 flex items-center justify-center gap-2";
                        // Inactive Style History
                        tabHistory.className = "flex-1 py-3 rounded-xl text-xs font-bold text-gray-400 hover:text-white hover:bg-white/5 transition-all text-center";
                        
                        calcTotal();
                    } else {
                        pendingSec.classList.add('hidden'); 
                        historySec.classList.remove('hidden');
                        
                        // Inactive Style Pending
                        tabPending.className = "flex-1 py-3 rounded-xl text-xs font-bold text-gray-400 hover:text-white hover:bg-white/5 transition-all flex items-center justify-center gap-2";
                        // Active Style History
                        tabHistory.className = "flex-1 py-3 rounded-xl text-xs font-bold transition-all duration-300 bg-brand-accent text-[#0B0F19] shadow-lg shadow-brand-accent/20 text-center";
                        
                        checkoutBar.classList.add('hidden-bar');
                    }
                }

                // Calculator Logic
                function calcTotal() {
                    const checkboxes = document.querySelectorAll('.cosmic-checkbox:checked');
                    let total = 0;
                    checkboxes.forEach(cb => total += parseFloat(cb.getAttribute('data-price')));
                    
                    const formatter = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 });
                    document.getElementById('total-text').innerText = formatter.format(total);
                    document.getElementById('selected-count').innerText = checkboxes.length;
                    
                    const bar = document.getElementById('checkout-bar');
                    const isPendingVisible = !document.getElementById('pending-section').classList.contains('hidden');
                    
                    if (checkboxes.length > 0 && isPendingVisible) {
                        bar.classList.remove('hidden-bar');
                    } else {
                        bar.classList.add('hidden-bar');
                    }
                }

                function cancelOrder(id) {
                    Swal.fire({ title: 'Hapus?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya', background: '#151C2C', color: '#fff', confirmButtonColor: '#EF4444' }).then((res) => {
                        if(res.isConfirmed) {
                            const form = document.getElementById('cancelForm');
                            form.action = '/android/order/cancel/' + id;
                            form.submit();
                        }
                    });
                }

                // Search Bar Animation Logic
                function toggleSearch(container) {
                    const input = container.querySelector('input');
                    if (container.classList.contains('expanded')) {
                         if (document.activeElement === input) return;
                         container.classList.remove('expanded');
                         // Reset styling if needed
                    } else {
                        container.classList.add('expanded');
                        setTimeout(() => input.focus(), 300); 
                    }
                }
                
                // Close search on click outside
                document.addEventListener('click', function(event) {
                    const searchContainer = document.querySelector('.search-container');
                    if (searchContainer && !searchContainer.contains(event.target)) {
                        searchContainer.classList.remove('expanded');
                    }
                });

                // Filter Logic
                document.getElementById('orderSearchInput').addEventListener('keyup', function() {
                    const filter = this.value.toLowerCase();
                    const items = document.querySelectorAll('.searchable-item');
                    items.forEach(item => {
                        const nameEl = item.querySelector('.search-name');
                        const idEl = item.querySelector('.search-id');
                        const textName = nameEl ? nameEl.textContent.toLowerCase() : '';
                        const textId = idEl ? idEl.textContent.toLowerCase() : '';
                        if (textName.includes(filter) || (textId && textId.includes(filter))) item.style.display = ""; else item.style.display = "none";
                    });
                });
            </script>
        </div>
    </div>
</body>
</html>